#!/bin/bash

# We have our own way of installing...
CUSTOM_BUILD=y

get_abs_path() {
    local parent_dir=$(dirname "$1")
    local _basename=$(basename "$1")
    case $_basename in
    ..)
        cd "$1"
        local abs_path="$(pwd -P)"
        ;;
    *)
        cd "$parent_dir"
        local abs_path="$(pwd -P)"/"$_basename"
    esac
    cd - >/dev/null
    echo "$abs_path"
}

# Check if java is installed
if type -p java; then
    JAVA=java
elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    JAVA="$JAVA_HOME/bin/java"
else
    echo "JAVA not found! If it is installed, please set JAVA_HOME to the appropriate location!"
    exit
fi

# Where are the existDB.jar file and install scripts
EXIST_SRC=$(dirname $(get_abs_path $0))

# Install the database
$EXIST_SRC/install $JAVA $EXIST_SRC $INSTALL_PREFIX

# Initialize the database
EXIST_HOME=$INSTALL_PREFIX/existdb

pushd $EXIST_HOME
$JAVA -jar $EXIST_HOME/start.jar jetty> /dev/null&
popd

echo "------------------------------------------"
echo "Configuration DB was started."


$INSTALL_PREFIX/bin/python $EXIST_SRC/init.py &> /dev/null

echo "------------------------------------------"
echo "Configuration DB was initialized."

pushd $EXIST_HOME
$JAVA -jar $EXIST_HOME/start.jar shutdown -p karabo
popd

# Wait a few seconds
sleep 5
# Force kill as server is pretty reluctant
pkill -9 -f jetty

echo "------------------------------------------"
echo "Configuration DB was stopped."
