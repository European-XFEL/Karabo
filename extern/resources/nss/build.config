CUSTOM_BUILD=y
CWD=$(pwd)
OS=$(uname -s)

source "$CWD/../../../set_lsb_release_info.sh"

if [ "$OS" = "Linux" ]; then
    DISTRO_ID=$(echo $LSB_RELEASE_DIST | sed -r 's/ /_/g')
    DISTRO_RELEASE=$LSB_RELEASE_VERSION
elif [ "$OS" = "Darwin" ]; then
    DISTRO_ID=MacOSX
    DISTRO_RELEASE=$(uname -r)
fi

echo "### Trying to install NSPR and NSS on the system $DISTRO_ID"

rm $CWD/libs.txt
if [ "$DISTRO_ID" = "Ubuntu" -o "$DISTRO_ID" == "Debian" ]; then
    dpkg -L libnspr4 libnss3 | grep -E "lib.+\.(so|chk)" > $CWD/libs.txt
elif [ "$DISTRO_ID" = "Scientific" -o "$DISTRO_ID" == "CentOS" -o "$DISTRO_ID" == "AlmaLinux" ]; then
    rpm -ql nspr nss nss-util nss-softokn nss-softokn-freebl | grep -E "lib.+\.(so|chk)" > $CWD/libs.txt
fi

rm $CWD/nspr.txt $CWD/nss.txt $CWD/pkgconfig.txt
if [ "$DISTRO_ID" = "Ubuntu" -o "$DISTRO_ID" = "Debian" ]; then
    # Ubuntu puts the NSPR & NSS headers in nspr/ and nss/ directories (without a version number)
    dpkg -L libnspr4-dev | grep -E ".+\.h" > $CWD/nspr.txt
    dpkg -L libnss3-dev | grep -E ".+\.h" > $CWD/nss.txt
    dpkg -L libnspr4-dev libnss3-dev | grep -E ".+\.pc" > $CWD/pkgconfig.txt
elif [ "$DISTRO_ID" = "Scientific" -o "$DISTRO_ID" == "CentOS" -o "$DISTRO_ID" == "AlmaLinux" ]; then
    # CentOS puts the NSPR & NSS headers in nspr4/ and nss3/ directories (with a version number)
    rpm -ql nspr-devel | grep -E ".+\.h" > $CWD/nspr.txt
    rpm -ql nss-devel nss-util-devel nss-softokn nss-softokn-devel nss-softokn-freebl nss-softokn-freebl-devel | grep -E ".+\.h" > $CWD/nss.txt
    rpm -ql nspr-devel nss-devel nss-util-devel nss-softokn nss-softokn-devel nss-softokn-freebl nss-softokn-freebl-devel | grep -E ".+\.pc" > $CWD/pkgconfig.txt
elif [ "$DISTRO_ID" = "openSUSE" -o "$DISTRO_ID" = "openSUSE_project" ]; then
    #openSUSE flavor ...
    rpm -ql mozilla-nspr-devel | grep -E ".+\.h" > $CWD/nspr.txt
    rpm -ql mozilla-nss-devel libsoftokn2 libfreebl2 | grep -E ".+\.h" > $CWD/nss.txt
    rpm -ql mozilla-nspr-devel mozilla-nss-devel libsoftokn3 libfreebl3 | grep -E ".+\.pc" > $CWD/pkgconfig.txt
fi

while read libfile
do
    cp -a $libfile $INSTALL_PREFIX/lib
    echo "Installing: $libfile"
done < $CWD/libs.txt

mkdir -p $INSTALL_PREFIX/include/nspr/
mkdir -p $INSTALL_PREFIX/include/nspr/obsolete
mkdir -p $INSTALL_PREFIX/include/nspr/private
while read nsprfile
do
    # Use sed to convert /usr/include/nspr[4]/banana.h -> nspr/banana.h
    destname=$(echo $nsprfile | sed "s/^\(.*\)\(nspr\)[4]*\/\(.*\)$/\2\/\3/g")
    cp -a $nsprfile $INSTALL_PREFIX/include/$destname
    echo "Installing: $nsprfile at $INSTALL_PREFIX/include/$destname"
done < $CWD/nspr.txt

mkdir -p $INSTALL_PREFIX/include/nss/
while read nssfile
do
    # Use sed to convert /usr/include/nss[3]/banana.h -> nss/banana.h
    destname=$(echo $nssfile | sed "s/^\(.*\)\(nss\)[3]*\/\(.*\)$/\2\/\3/g")
    cp -a $nssfile $INSTALL_PREFIX/include/$destname
    echo "Installing: $nssfile at $INSTALL_PREFIX/include/$destname"
done < $CWD/nss.txt

while read pkgconfigfile
do
    cp -a $pkgconfigfile $INSTALL_PREFIX/lib
    echo "Installing: $pkgconfigfile"
done < $CWD/pkgconfig.txt

 
