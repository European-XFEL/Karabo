

# The LDFLAGS used to build the Python interpreter are saved in its Makefile.
# The same flags are then used to build all extension modules that are built
# with distutils (setup.py). The RPATH for the Python interpreter does not make
# sense for extension modules, so we rewrite the Makefile to omit these flags.
rewriteMakefile() {
    pushd $($INSTALL_PREFIX/bin/python -m sysconfig | grep LIBPL | cut -d= -f2 | tr -d '"')
    sed -i '/^CONFIGURE_LDFLAGS/s/.*/CONFIGURE_LDFLAGS=/' Makefile
    # Additionally, LIBDIR is specific to where Karabo is installed
    sed -i '/^LIBDIR=/s/.*/LIBDIR=         ${prefix}\/lib/' Makefile
    popd
}


DEP_NAME="Python-3.6.6"
DEP_EXT="tar"
EXTRACT_COMMAND="tar -xf $DEP_NAME.$DEP_EXT"
CONFIGURE_COMMAND="./configure --prefix=$INSTALL_PREFIX --libdir=$INSTALL_PREFIX/lib --without-ensurepip --enable-shared LDFLAGS=-Wl,-rpath,\\\\\\\$\\\$ORIGIN/../lib"
MAKE_COMMAND="make -j"
INSTALL_COMMAND="make install; pushd $INSTALL_PREFIX/bin; ln -fs python3 python; popd; rewriteMakefile "
