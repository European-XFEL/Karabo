#!/bin/bash

CUSTOM_BUILD=y
CWD=$(pwd)
# get OpenMQ binary package

#wget http://download.java.net/mq/open-mq/4.5.2/latest/openmq4_5_2-binary-Linux_X86.zip

# Surprisingly, it turned out that setting java home is not necessary, as simply /usr/bin/java is used to start broker
# find java location
#if [ "$DISTRO_ID" == "Scientific" ]; then
#tmp=$(/usr/sbin/alternatives --display java |grep 'link currently points to'| awk -F/ '{for (i = 2; i <= 5; i++) printf "/%s", $i}')
#elif [ "$DISTRO_ID" == "Ubuntu" ]; then
#tmp=$(update-alternatives --display java |grep 'link currently points to'| awk -F/ '{for (i = 2; i <= 5; i++) printf "/%s", $i}')
#fi
#if [ -z $tmp ]; then
#    echo
#    echo "No java found on the system"
#    echo "Install java and set IMQ_DEFAULT_JAVAHOME=... in \$KARABO/extern/MessageQueue/etc/mq/imqenv.conf"
#    echo
#else
#    defaultJavaHome=$tmp
#fi
   


# unzip to default location
defaultDir=MessageQueue

unzip -q openmq4_5_2-binary-Linux_X86.zip -d $defaultDir

# patch config files (adjust if necessary)

cd $defaultDir/etc/mq
#cp imqenv.conf imqenv.conf.orig
#echo "IMQ_DEFAULT_JAVAHOME=$defaultJavaHome" >> imqenv.conf
cp imqbrokerd.conf imqbrokerd.conf.orig
sed -i 's/AUTOSTART=NO/AUTOSTART=YES/' imqbrokerd.conf
sed -i 's/ARGS=/ARGS=-vmargs "-server -Xmx1g -Xms1g"/' imqbrokerd.conf

cd rc
cp imq imq.orig

# put this lines at the begining of imq init script 
#
# imq           This starts and stops the MQ Broker  
#                                                    
# chkconfig: 35 52 15                                
# description: Starts and stops the MQ broker at boot time and shutdown.

sed -ie '/^#!/a #\n# imq           This starts and stops the MQ Broker\n#\n# chkconfig: 35 52 15\n# description: Starts and stops the MQ broker at boot time and shutdown.' imq

# changes in the following lines in imq init script
# IMQ_HOME=/usr/local/MessageQueue
# IMQ_ETCHOME="$IMQ_HOME/etc/mq"
# su -c "$IMQ_HOME/mq/bin/$EXECUTABLE -bgnd $BROKER_OPTIONS $ARGS &" - mqbroker

sed -i 's/IMQ_HOME=\/opt\/sun\/mq/cd $(dirname $0)\nIMQ_HOME=..\/MessageQueue/' imq
sed -i 's/IMQ_ETCHOME="\/etc\/opt\/sun\/mq"/IMQ_ETCHOME="$IMQ_HOME\/etc\/mq"/' imq
#sed -i 's/bin\/$EXECUTABLE -bgnd $BROKER_OPTIONS $ARGS \&/$IMQ_HOME\/mq\/bin\/$EXECUTABLE -bgnd $BROKER_OPTIONS $ARGS \&/' imq
sed -i 's/bin\/$EXECUTABLE -bgnd $BROKER_OPTIONS $ARGS \&/echo "$IMQ_HOME\/mq\/bin\/$EXECUTABLE -bgnd $BROKER_OPTIONS $ARGS \&" | sh/' imq
sed -i 's/\/bin\/awk/awk/' imq
sed -i 's/\# export IMQ_VARHOME/export IMQ_VARHOME=..\/..\/var\/mq/' imq

chmod +x imq

cd  $CWD

cp $defaultDir/etc/mq/rc/imq $INSTALL_PREFIX/bin
cp -r $defaultDir $INSTALL_PREFIX

cd $INSTALL_PREFIX/bin

cat > imqcmd <<End-of-file
#!/bin/bash
#
# This file was automatically generated. Do not edit.
#
#if [ -z \$KARABO ]; then
#    if [ -e \$HOME/.karabo/karaboFramework ]; then
#        KARABO=\$(cat \$HOME/.karabo/karaboFramework)
#    else
#      echo "ERROR Could not find karaboFramework. Make sure you have installed the karaboFramework."
#      exit 1
#    fi
#fi
cd \$(dirname \$0)
host=localhost
port=7676
user=admin
#pass=\$KARABO/extern/MessageQueue/etc/mq/passfile.sample
pass=../MessageQueue/etc/mq/passfile.sample

#\$KARABO/extern/MessageQueue/mq/bin/imqcmd -b \$host:\$port -u \$user -passfile \$pass \$@

../MessageQueue/mq/bin/imqcmd -b \$host:\$port -u \$user -passfile \$pass \$@


End-of-file

chmod u+x imqcmd

cd $CWD
