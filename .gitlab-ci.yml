.deps_build_template: &deps_build
  script:
    - pushd extern
    - export DEPS_BASE_NAME=$(lsb_release -is)-$(lsb_release -rs | sed -r "s/^([0-9]+).*/\1/")
    - export DEPS_DIR_ABS_PATH=$(pwd -P)/$DEPS_BASE_NAME
    - bash build.sh -q $DEPS_BASE_NAME CI
    - $DEPS_BASE_NAME/bin/python3 ./builder_path_replace.py --fix-links $DEPS_BASE_NAME/bin $DEPS_DIR_ABS_PATH __KARABO_CI_PATH__
    - $DEPS_BASE_NAME/bin/python3 ./builder_path_replace.py $DEPS_BASE_NAME/lib $DEPS_DIR_ABS_PATH __KARABO_CI_PATH__
    - bash build.sh -p $DEPS_BASE_NAME CI
    - sshpass -p "$XDATA_PWD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPS_BASE_NAME*.tar.gz xdata@exflserv05:/var/www/html/karabo/karaboDevelopmentDeps/
  only:
    - /^deps-.+$/
  except:
    - branches

.release_build_template: &release_build
  script:
    - export REL_OS_NAME=$(lsb_release -is)
    - export REL_OS_VERS_LONG=$(lsb_release -rs)
    - export REL_TAG=$CI_BUILD_REF_NAME
    - export REL_ARTIFACT_NAME=karabo-$REL_TAG-Release-$REL_OS_NAME-$REL_OS_VERS_LONG-x86_64.sh
    - export REL_ARTIFACT_DEST=karaboFramework/tags/$REL_TAG
    - bash ./auto_build_all.sh Release --noDbInit
    - mv package/Release/$REL_OS_NAME/$REL_OS_VERS_LONG/x86_64/karabo-*.sh $REL_ARTIFACT_NAME
    - sshpass -p "$XDATA_PWD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null xdata@exflserv05 "mkdir -p /var/www/html/karabo/$REL_ARTIFACT_DEST"
    - sshpass -p "$XDATA_PWD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $REL_ARTIFACT_NAME xdata@exflserv05:/var/www/html/karabo/$REL_ARTIFACT_DEST
  only:
    - /^(\d+\.)(\d+\.)(\d+)$/
  except:
    - branches

.mr_test_template: &mr_test_build
  before_script:
    - locale-gen en_US.UTF-8
    - update-locale LANG=en_US.UTF-8
  script:
    - export KARABO_BROKER_TOPIC="gitlab_ci_$CI_BUILD_ID"
    - bash ./auto_build_all.sh Debug --noBundle --runTests
  only:
    - branches
  except:
    - master

.integration_test_template: &integration_test_build
  before_script:
    - locale-gen en_US.UTF-8
    - update-locale LANG=en_US.UTF-8
  script:
    - export KARABO_BROKER_TOPIC="gitlab_ci_$CI_BUILD_ID"
    - bash ./auto_build_all.sh Debug --noBundle --runIntegrationTests
  only:
    - master

deps:ubuntu14:
  <<: *deps_build
  image: jwiggins/karabo-containers:ubuntu-14

deps:ubuntu16:
  <<: *deps_build
  image: jwiggins/karabo-containers:ubuntu-16

deps:centos7:
  <<: *deps_build
  image: jwiggins/karabo-containers:centos-7

release:ubuntu14:
  <<: *release_build
  image: jwiggins/karabo-containers:ubuntu-14
  before_script:
    - locale-gen en_US.UTF-8
    - update-locale LANG=en_US.UTF-8

release:ubuntu16:
  <<: *release_build
  image: jwiggins/karabo-containers:ubuntu-16
  before_script:
    - locale-gen en_US.UTF-8
    - update-locale LANG=en_US.UTF-8

release:centos7:
  <<: *release_build
  image: jwiggins/karabo-containers:centos-7
  before_script:
    - localedef -c -i en_US -f UTF-8 en_US.utf8
    - export LANG=en_US.UTF-8

test:ubuntu14:
  <<: *mr_test_build
  image: jwiggins/karabo-containers:ubuntu-14

integration:ubuntu14:
  <<: *integration_test_build
  image: jwiggins/karabo-containers:ubuntu-14
