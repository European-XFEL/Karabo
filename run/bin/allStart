#! /bin/bash
####################################################################################
# allStart starts the applications defined in ALLINFO in separate xterms
# additional information (including arguements) are described in ./allInfo
# author: CY 18.12.2012

# check startup
./allCheck
check=$?

if [ -n "$RESTART" ] && [ "$check" = "13" ]; then
    echo "INFO restart any missing xterms"
elif  [ -n "$RESTART" ] && [ "$check" = "0" ]; then
    echo "INFO restart all xterms"
elif [ "$check" != "0" ]; then 
    echo "ERROR xterms running cannot allStart"
    exit 1;
fi;

# Clean old pid file
mv .allStart.pid .allStart.pid.last 2> /dev/null

# cleanup old xml files
./allClean

# ALLINFO content checking is done in allCheck 
source ./allInfo

# store args for possible restart
if [ "$check" = "0" ]; then
    echo "args: $0 $@" >> .allInfo 
fi

for key in "${!ALLINFO[@]}"
do
    value=${ALLINFO[$key]}
    source ./.allParse

    # the match is too indescriminant and fails to identify all cases! Correct solution use pid chain?
    job=$(ps -u $USER -o  pid,ppid,pgrp,user,cmd | grep -v grep | grep $match | awk '{print $1}')

    if [ -n "$job" ]; then
        echo "INFO key $key running, not restarting"
    elif [ "$name" = "gui" ] && [ "$NOGUI" = "true" ]; then
        echo "INFO NOGUI environmental is 'true', gui not started"
    else 
        target=$dir/$exe
        title=${dir##[./]*/}/$exe
        options="-T $title -sb -rightbar -sl $scroll"
	display=""
	if [ -n "$XUSE" ] && [ "$xuse" = "yes" ]; then
	    display="-display $XUSE"
	fi
        if [ "$1" = "-nox" ]; then
            # No xterms should be used
	    echo "INFO Starting: $target $params 2>&1 > /dev/null &"
	    $target $params 2>&1 > /dev/null &
	else
            echo "INFO Starting: xterm $options $display -e $target $params $redirect &"
	    xterm $options $display -e "$target $params $redirect" &
        fi
	# store name and pid of started process
        bg=$!
	# Give the xterm processes time to start and set up their pids
	sleep 0.5 
        echo "key: $match $!" >> .allInfo 
	echo -n "$bg," >> .allStart.pid
	cpid=`pgrep -P $bg`
	echo -n "$cpid," >> .allStart.pid
	# Sleep as defined in allInfo
	sleep $wait
    fi    
done
# Persist own PID
echo "$$" >> .allStart.pid
exit 0
