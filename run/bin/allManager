#! /bin/bash
##########################################################################
# use this script to execute commands on tst stand hosts
# An accumulated error (set for any connect or target execution error) is
# set, the caller is at liberty to interpret this as he wants !
#

if [ $# != 3 ]
then
    echo "Runs script or executable on one, or more, SSH or RSH hosts"
    echo "./allManager username-on-target-host blank-separated-host-list pathname-of-script/executable"
    echo "e.g.: export SSHNODES=\"exflpcx18661 exflpcx18551\" date"
    echo "e.g.: ./allManager xbeam \"exflpcx18661\" date"
    exit 1
fi

USERNAME=$1
HOSTLIST=$2
EXECPATH=$3

errflag="0"
hstflag="0"

for target in $HOSTLIST
do
    for node in $SSHNODES
    do
	if [ $target == $node ]; 
	then
	    hstflag="1"
	    if ping -c 1 -w 2 $node &> /dev/null
	    then
		echo "ssh-target $target"
		ssh -X $USERNAME@$node $EXECPATH
		if [ "$?" != "0" ]; then
		    errflag="1"
		fi
	    else
		echo "ssh-target $target does not respond - Skip"
		errflag="1"
	    fi
	fi
    done

    for node in $RSHNODES
    do
	if [ $target == $node ]; 
	then
	    hstflag="1"
            if ping -c 1 -w 2 $node &> /dev/null
            then
		echo "rsh-target $target"
		rsh -l $USERNAME $node $EXECPATH
            else
                echo "rsh-target $target does not respond - Skip"
		errflag="1"
            fi
	fi
    done
done

if [ "$hstflag" == "0" ]; then
    errflag="1"
fi

exit $errflag

