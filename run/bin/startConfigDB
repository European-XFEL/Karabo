#!/bin/bash


EXIST_BASE="$KARABO/extern/eXistDB"
EXIST_HOME="$KARABO/extern/eXistDB/db"
CURRENT_DIR=`pwd`

#check if java is installed
if type -p java; then
    JAVA=java
elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]];  then
    JAVA="$JAVA_HOME/bin/java"
else
    echo "JAVA not found! If it is installed, please set JAVA_HOME to the appropriate location!"
    exit 
fi

#first we check if the database is installed
if [ ! -d "$EXIST_HOME" ]; then
	cd $EXIST_BASE
	./install $JAVA
	#now insure it is initialized after we've given it some time to finish installation.
	sleep 10s
	$KARABO/extern/bin/python3 -c "from karabo.project_db import util; util.init_local_db();"
fi

##TODO add checks if DB is initialized. This will be added by calling python API functions

#finally, start the db server
cd $EXIST_HOME
$JAVA -jar $EXIST_HOME/start.jar jetty&
echo "------------------------------------------"
echo "Configuration DB was started."
echo "You can access the backend at: http://localhost:8080/exist/"
cd $CURRENT_DIR
