#!/usr/bin/env bash

__deps_build_tests() {
    export FORCED_DEPS_TAG=$CI_COMMIT_REF_SLUG
    bash ./auto_build_all.sh Debug --runTests --runIntegrationTests
}

__conda_tests() {
    . ci/utils/enable_internet.sh

    bash ./run_python_tests.sh --runCondaUnitTests --rootDir .

    . ci/utils/disable_internet.sh
}

__cmake_tests() {
    . ci/utils/enable_internet.sh
    curl http://exflserv05.desy.de/karabo/miniconda3/Miniconda3-latest-Linux-x86_64.sh -o /root/miniconda.sh
    bash /root/miniconda.sh -b -f -p /root/miniconda3
    source /root/miniconda3/etc/profile.d/conda.sh
    conda create -n cmake -y
    conda activate cmake
    conda install cmake
    pushd ./build/cmake
    cmake ../..
    export NUM_JOBS=$(grep "processor" /proc/cpuinfo | wc -l)
    make -j$NUM_JOBS
    make test
    popd
    . ci/utils/disable_internet.sh
}

__unit_tests() {
    bash ./auto_build_all.sh Debug --runTests
}

__integration_tests() {
    bash ./auto_build_all.sh Debug --runIntegrationTests
}


echo "Start to testing job: {$1}"

JOB_SCOPE=$(echo $1 | cut -f1 -d' ')
JOB_TYPE=$(echo $1 | cut -f2 -d' ')
TARGET_OS=$(echo $1 | cut -f3 -d' ')

export KARABO_BROKER_TOPIC="gitlab_ci_$CI_JOB_ID"
export KARABO_PROJECT_DB=existdb_host
export KARABO_PROJECT_DB_PORT=8080
export KARABO_TEST_PROJECT_DB=existdb_host
export KARABO_TEST_PROJECT_DB_PORT=8080
export KARABO_TEST_INFLUXDB_HOST=influxdb_host
export KARABO_TEST_INFLUXDB_PORT=8086

if [ "$TARGET_OS" = "miniconda" ]; then
    __conda_tests
elif [ "$TARGET_OS" = "miniconda-cmake" ]; then
    __cmake_tests
else
    case "$JOB_SCOPE" in
        deps) __deps_build_tests ;;
        unit) __unit_tests ;;
        integration) __integration_tests ;;
        *) echo "unknown job scope: $JOB_SCOPE" ;;
    esac
fi
